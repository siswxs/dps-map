<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞—Ä—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ ‚Äî –°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥</title>

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Yandex Maps -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=3b8d4e93-e8bd-493b-890e-d985fd8d1b3c&lang=ru_RU"></script>

  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
ymaps.ready(() => {

  const CITY_CENTER = [56.3069, 38.1503]; // –°–µ—Ä–≥–∏–µ–≤ –ü–æ—Å–∞–¥
  const MAX_DISTANCE_KM = 15;
  const API_URL = "https://script.google.com/macros/s/AKfycbxZFmcB-chOleBYl1pMzgokDvi4Jg_dlAMMUVdVSAqWHIpqfUgH94acmGxAQZODo2bwHA/exec";

  const map = new ymaps.Map("map", {
    center: CITY_CENTER,
    zoom: 12,
    controls: ['zoomControl']
  });

  // –ö—Ä—É–≥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è 15 –∫–º
  const limitCircle = new ymaps.Circle(
    [CITY_CENTER, MAX_DISTANCE_KM * 1000],
    {},
    {
      fillColor: "rgba(255,0,0,0.05)",
      strokeColor: "#ff0000",
      strokeWidth: 2,
      strokeOpacity: 0.6
    }
  );
  map.geoObjects.add(limitCircle);

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫ —Å Google Sheets
  loadPoints();

  // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
  map.events.add('click', (e) => {
    const coords = e.get('coords');

    if (!insideRadius(coords)) {
      alert("‚ùå –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–∫—Ä—É–≥–∞ (15 –∫–º)");
      return;
    }

    addPoint(coords);
    savePoint(coords);
  });

  function addPoint(coords) {
    const placemark = new ymaps.Placemark(
      coords,
      { balloonContent: "üöì –ü—Ä–æ–≤–µ—Ä–∫–∞" },
      { preset: "islands#redIcon" }
    );
    map.geoObjects.add(placemark);
  }

  function savePoint(coords) {
    fetch(API_URL + "?action=add&lat=" + coords[0] + "&lon=" + coords[1])
      .then(res => res.text())
      .then(res => console.log(res));
  }

  function loadPoints() {
    fetch(API_URL + "?action=get")
      .then(res => res.json())
      .then(data => {
        data.forEach(coords => addPoint(coords));
      });
  }

  function insideRadius(coords) {
    const distance = ymaps.coordSystem.geo.getDistance(CITY_CENTER, coords);
    return distance <= MAX_DISTANCE_KM * 1000;
  }

});
</script>

</body>
</html>
